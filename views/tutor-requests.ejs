<h2>Tutor Dashboard</h2>

<h3>Open Tutoring Requests</h3>
<% if (openRequests.length > 0) { %>
  <ul class="list-group mb-4">
    <% openRequests.forEach(function(request) { %>
      <li class="list-group-item">
        <h4>Request from <%= request.student_name %> (Topic: <%= request.topic %>)</h4>
        <p><strong>Details:</strong> <%= request.details %></p>
        <p><strong>Preferred Times:</strong> <%= request.preferred_time_windows ? JSON.parse(request.preferred_time_windows).map(t => `${t.day} ${t.start}-${t.end}`).join(', ') : 'N/A' %></p>
        <p><strong>Requested On:</strong> <%= new Date(request.created_at).toLocaleString() %></p>

        <% if (request.status === 'pending') { %>
          <form action="/tutor/requests/<%= request.id %>/accept" method="POST" class="d-inline-block me-2">
            <div class="form-group">
                <label for="proposed_start_time">Propose Start Time</label>
                <input type="datetime-local" name="proposed_start_time" required>
            </div>
            <div class="form-group">
                <label for="proposed_end_time">Propose End Time</label>
                <input type="datetime-local" name="proposed_end_time" required>
            </div>
            <button type="submit" class="btn btn-success btn-sm mt-2">Accept & Propose Time</button>
          </form>
          <form action="/tutor/requests/<%= request.id %>/decline" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to decline this request?');">
            <button type="submit" class="btn btn-danger btn-sm mt-2">Decline</button>
          </form>
        <% } else { %>
          <p>Status: <strong><%= request.status %></strong></p>
        <% } %>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p class="text-muted">No open tutoring requests.</p>
<% } %>

<h3>Upcoming Sessions</h3>
<% if (upcomingSessions.length > 0) { %>
  <ul class="list-group mb-4">
    <% upcomingSessions.forEach(function(session) { %>
      <li class="list-group-item">
        <h4>Session with <%= session.student_name %> (Topic: <%= session.topic %>)</h4>
        <p><strong>Time:</strong> <%= new Date(session.start_time).toLocaleString() %> - <%= new Date(session.end_time).toLocaleString() %></p>
        <p><strong>Status:</strong> <%= session.status %></p>
        <a href="/tutor/sessions/<%= session.id %>/summary" class="btn btn-info btn-sm">Log Summary / Materials</a>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p class="text-muted">No upcoming sessions.</p>
<% } %>

<h3>Past Sessions</h3>
<% if (pastSessions.length > 0) { %>
  <ul class="list-group">
    <% pastSessions.forEach(function(session) { %>
      <li class="list-group-item">
        <h4>Session with <%= session.student_name %> (Topic: <%= session.topic %>)</h4>
        <p><strong>Time:</strong> <%= new Date(session.start_time).toLocaleString() %> - <%= new Date(session.end_time).toLocaleString() %></p>
        <p><strong>Status:</strong> <%= session.status %></p>
        <p><strong>Tutor Notes:</strong> <%= session.tutor_notes || 'N/A' %></p>
        <p><strong>Student Feedback:</strong> <%= session.student_feedback || 'N/A' %></p>
        <a href="/tutor/sessions/<%= session.id %>/summary" class="btn btn-info btn-sm">View/Edit Summary</a>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p class="text-muted">No past sessions.</p>
<% } %>